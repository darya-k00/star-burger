{% extends 'base_restaurateur_page.html' %}

{% block title %}Необработанные заказы | Star Burger{% endblock %}

{% block content %}
  <center>
    <h2>Необработанные заказы</h2>
  </center>

  <hr/>
  <br/>
  <style>
    .comment-column {
      max-width: 120px;
      word-wrap: break-word;
    }
    .distance-info {
      font-size: 12px;
      color: #666;
      margin-top: 2px;
    }
    .no-restaurants {
      color: #dc3545;
      font-weight: bold;
    }
    .text-danger {
      color: #dc3545;
      font-weight: bold;
      padding: 5px;
      background-color: #f8d7da;
      border: 1px solid #f5c6cb;
      border-radius: 4px;
    }
  </style>

  <div class="container">
   <table class="table table-responsive">
    <tr>
      <th>ID заказа</th>
      <th>Статус</th>
      <th>Клиент</th>
      <th>Телефон</th>
      <th>Адрес доставки</th>
      <th>Рестораны</th>
      <th>Способ оплаты</th>
      <th>Создан</th>
      <th>Позвонили</th>
      <th>Доставлен</th>
      <th>Сумма заказа</th>
      <th class="comment-column">Комментарий клиента</th>
      <th class="comment-column">Комментарий менеджера</th>
      <th>Состав заказа</th>
      <th>Редактировать</th>
    </tr>

    {% for order in orders %}
      <tr>
        <td>{{ order.id }}</td>
        <td>
          {% if order.status == 'Новый' %}
            <span class="label label-primary">{{ order.status }}</span>
          {% elif order.status == 'В обработке' %}
            <span class="label label-warning">{{ order.status }}</span>
          {% elif order.status == 'Завершен' %}
            <span class="label label-success">{{ order.status }}</span>
          {% elif order.status == 'Отменен' %}
            <span class="label label-danger">{{ order.status }}</span>
          {% else %}
            <span class="label label-default">{{ order.status }}</span>
          {% endif %}
        </td>
        <td>{{ order.firstname }} {{ order.lastname }}</td>
        <td>{{ order.phonenumber }}</td>
        <td>{{ order.address }}</td>
        <td>
          {% if order.cooking_restaurant %}
            <div class="selected-restaurant">
               {{ order.cooking_restaurant.name }}
            </div>
          {% else %}
            {% if not order.is_address_found %}
              <!-- Если адрес не найден -->
              <div class="text-danger">
                 Адрес не найден
              </div>
            {% else %}
              {% if order.available_restaurants %}
                <div class="restaurant-info">
                  <strong>Могут приготовить:</strong>
                  {% for restaurant_info in order.available_restaurants %}
                    <div class="available-restaurant">
                      • {{ restaurant_info.restaurant.name }}
                      {% if restaurant_info.distance is not None %}
                        <div class="distance-info">
                           ~{{ restaurant_info.distance|floatformat:2 }} км
                        </div>
                      {% endif %}
                    </div>
                  {% endfor %}
                </div>
              {% else %}
                <div class="no-restaurants">
                   Нет подходящих ресторанов
                </div>
              {% endif %}
            {% endif %}
          {% endif %}
        </td>
        <td>
          {% if order.payment_method == 'Наличными' %}
            <span class="label label-info"> {{ order.payment_method }}</span>
          {% elif order.payment_method == 'Электронно' %}
            <span class="label label-success"> {{ order.payment_method }}</span>
          {% else %}
            <span class="label label-default">{{ order.payment_method }}</span>
          {% endif %}
        </td>
        <td>{{ order.created_at|date:"d.m.Y H:i" }}</td>
        <td>{{ order.called_at|date:"d.m.Y H:i"|default:"-" }}</td>
        <td>{{ order.delivered_at|date:"d.m.Y H:i"|default:"-" }}</td>
        <td><strong>{{ order.total_amount }} руб.</strong></td>
        <td class="comment-column">{{ order.comment|default:"-" }}</td>
        <td class="comment-column">{{ order.manager_comment|default:"-" }}</td>
        <td>
          <ul>
            {% for product in order.products %}
              <li>{{ product }}</li>
            {% endfor %}
          </ul>
        </td>
        <td>
          <a href="{% url 'admin:foodcartapp_order_change' order.id %}?next={{ request.path|urlencode }}">
            Редактировать
          </a>
        </td>
      </tr>
    {% empty %}
      <tr>
        <td colspan="15" class="text-center">Нет необработанных заказов</td>
      </tr>
    {% endfor %}
   </table>
  </div>
{% endblock %}